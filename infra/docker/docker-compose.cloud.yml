services:
  nats:
    image: nats:2
    ports:
      - "4222:4222"
      - "8222:8222"
    command: ["-js", "-m", "8222"]

  gateway:
    image: "${ECR_GATEWAY}:${IMAGE_TAG}"
    cap_add:
      - NET_ADMIN
    environment:
      NATS_URL: nats://nats:4222
      GATEWAY_ADDR: :8080
      PPROF_ADDR: :6060
      JWT_SECRET: ${JWT_SECRET}
      JWT_REFRESH_SECRET: ${JWT_REFRESH_SECRET}
      CORS_ORIGIN: ${CORS_ORIGIN}
      POSTGRES_DSN: ${POSTGRES_DSN}
      REDIS_ADDR: ${REDIS_ADDR}
    ports:
      - "8080:8080"
      - "6060:6060"
    depends_on:
      - nats

  messages:
    image: "${ECR_MESSAGES}:${IMAGE_TAG}"
    cap_add:
      - NET_ADMIN
    environment:
      NATS_URL: nats://nats:4222
      SUBJECT: storm.events
      MESSAGES_ADDR: :8081
      PPROF_ADDR: :6061
    ports:
      - "8081:8081"
      - "6061:6061"
    depends_on:
      - nats

  prometheus:
    image: prom/prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro

  grafana:
    image: grafana/grafana
    ports:
      - "3000:3000"
    volumes:
      - grafana_data:/var/lib/grafana

volumes:
  grafana_data:
