name: CD (Kubernetes)

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "k8s environment (dev/staging/prod)"
        required: true
        default: "staging"
      image_tag:
        description: "Image tag"
        required: true
        default: "latest"
      deploy:
        description: "Apply manifests to cluster"
        required: true
        default: "false"

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push gateway
        run: |
          IMAGE=ghcr.io/${{ github.repository_owner }}/storm-gateway:${{ inputs.image_tag }}
          docker build -t "$IMAGE" services/gateway
          docker push "$IMAGE"

      - name: Build and push messages
        run: |
          IMAGE=ghcr.io/${{ github.repository_owner }}/storm-messages:${{ inputs.image_tag }}
          docker build -t "$IMAGE" services/messages
          docker push "$IMAGE"

  deploy:
    runs-on: ubuntu-latest
    needs: build-and-push
    if: ${{ inputs.deploy == 'true' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: "v1.30.0"

      - name: Configure kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBECONFIG_B64 }}" | base64 -d > ~/.kube/config

      - name: Update image tags (kustomize)
        run: |
          sed -i "s|newTag: .*|newTag: ${{ inputs.image_tag }}|g" infra/k8s/kustomization.yaml
          sed -i "s|newName: storm-gateway|newName: ghcr.io/${{ github.repository_owner }}/storm-gateway|g" infra/k8s/kustomization.yaml
          sed -i "s|newName: storm-messages|newName: ghcr.io/${{ github.repository_owner }}/storm-messages|g" infra/k8s/kustomization.yaml

      - name: Apply manifests
        run: |
          kubectl apply -k infra/k8s

